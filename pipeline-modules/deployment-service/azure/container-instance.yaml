provisioner: azure
name: container-instance
version: 1
revision: 1
displayName: Azure Container Instances
description: Module for the azure container instance deployment
target: "deployment-template"
keywords: ["container", "linux"]
author: CloudCover
meta:
  inputArtifactType:
    - "container"
inputs:
  type: object
  properties:
    region:
      title: Region name
      description: region name for container instance
      type: string
    app_env:
      title: Application Environment
      description: Application Related Envs
      type: object
      default: {}
    repository:
      title: Container Repository
      description: Enter Full container url without tag
      type: string
      default: ""
    tag:
      title: Container tag
      description: Tagged container will deploy
      type: string
      default: latest
    resourceGroup:
      title: Azure resource group
      description: Resource groups allow you to organize and manage related Azure resources
      type: string
      default: ""
    memory:
      title: Memory
      description: Memory to be consumed by app runner
      type: string
      default: "1"
    cpu:
      title: CPU
      description: CPU to be consumed by app runner
      type: string
      default: "1"
    port:
      title: Container port
      type: integer
      maximum: 65535
    applicationName:
      title: Application name
      description: This is vanguard application name
      type: string
      default: latest
    environment:
      title: Environment Name
      description: This is vanguard environment name
      type: string
      default: latest
    project:
      title: Project Name
      description: This is a vanguard project name
      type: string
      default: latest
    job_type:
      title: Job Type
      description: This is to deploy or undeploy application
      type: string
      default: deploy
    pipeline_env:
      title: Global Environment
      description: Mapping of globally available variables to values.
      type: object
      default: {}
    pipeline_secret_env:
      title: Global Secret Environment
      description: Mapping of globally available variables to encrypted values.
      type: object
      default: {}
  required:  ["region","port"]
  internal:
    - app_env
    - repository
    - tag
    - applicationName
    - environment
    - project
    - job_type
    - pipeline_env
    - pipeline_secret_env
template: |
  {% set workspace = '$BUILD_SOURCESDIRECTORY' %}
  {% set pipeline_env_file = workspace|add:'/.env' %}

  steps:
  - script: |
      echo "Deploying azure container instance with following variables:
      Region: {{region}}
      Repository: {{repository}}
      Tag: {{tag}}
      Port: {{port}}
      Application Name: {{applicationName}}
      Environment: {{environment}}
      Project: {{project}}
      Resource Group: {{resourceGroup}}
      Memory: {{memory}}
      CPU: {{cpu}}"

      {% if job_type == 'deploy' %}

      values=$(cat {{ pipeline_env_file }} | while IFS= read -r line; do
        value=${line#*=}
        name=${line%%=*}
        printf '%s=%s ' $name $value
      done;)

      # values=("")
      # {%- for env_key in pipeline_env %}
      #   values+=$(printf '%s=%s ' {{env_key}} "$({{env_key}})")
      # {% endfor %}
      # {%- for env_key in pipeline_secret_env %}
      #   values+=$(printf '%s=%s ' {{env_key}} "$({{env_key}})")
      # {% endfor %}

      echo "Values are $values"

      az login --service-principal -u $(ARM_CLIENT_ID) -p $(ARM_CLIENT_SECRET) -t $(ARM_TENANT_ID)
      az account set --subscription $(ARM_SUBSCRIPTION_ID)
      echo "Successfully logged in azure CLI"

      az container create --resource-group {{resourceGroup}} --name {{applicationName}} --image {{repository}}:{{tag}} --cpu {{cpu}} --memory {{memory}} --registry-login-server $(docker_registry) --registry-username $(docker_username) --registry-password $(docker_password) --ports {{port}} --dns-name-label {{applicationName}} --restart-policy OnFailure --environment-variables $values

      echo "###pipeline-summary-start###" >> summary.txt 2>&1;
      summary=$(az container show --name borat-app --resource-group {{resourceGroup}} --query ipAddress.fqdn)
      echo "Service URL="$summary >> summary.txt
      echo "###pipeline-summary-end###" >> summary.txt 2>&1;
      cat summary.txt;

      {% else %}
      echo "Un-deploy the application {{applicationName}} ..."
      {% endif %}
      az logout


